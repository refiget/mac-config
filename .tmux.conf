# ============================================================
# 1. åŸºç¡€é€šç”¨è®¾ç½®
# ============================================================
unbind C-b
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",*:Tc"
set -g mouse on
set -g mode-keys vi
setw -g aggressive-resize on
set -g status-right ""


# --- è§†è§‰è®¾ç½® ---
set -g status-left-length 50
set -g window-status-style "fg=#6272a4"
set -g window-status-format " #I:#W "
set -g window-status-current-format " #I:#W "
set -g pane-border-style "fg=#44475a"
set -g message-style "bg=#ffb86c,fg=#282a36"

# --- çª—å£/åˆ†å±æŒ‰é”®ç»‘å®š ---
bind-key | split-window -h
bind-key - split-window -v
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

bind-key -n Left  resize-pane -L 5
bind-key -n Right resize-pane -R 5
bind-key -n Up    resize-pane -U 5
bind-key -n Down  resize-pane -D 5
bind-key -r Left  resize-pane -L 5
bind-key -r Right resize-pane -R 5
bind-key -r Up    resize-pane -U 5
bind-key -r Down  resize-pane -D 5

# ============================================================
# ðŸš€ Session ç®¡ç†ä¼˜åŒ– (FZF + æ™ºèƒ½åˆ‡æ¢)
# ============================================================

# 1. æ¸…ç†æ—§é”®ä½ (é˜²æ­¢å†²çª)
unbind n
unbind y
unbind b

# 2. å¿«é€Ÿåˆ‡æ¢ (Alt-Tab ä½“éªŒ)
# ä½œç”¨ï¼šåœ¨"å½“å‰"å’Œ"ä¸Šä¸€ä¸ª" Session ä¹‹é—´åå¤æ¨ªè·³
bind-key Tab switch-client -l

# 3. æ–°å»º Session
# ä½œç”¨ï¼šæç¤ºè¾“å…¥åå­—ï¼Œç„¶åŽåˆ›å»º
bind-key n command-prompt -p "New Session:" "new-session -A -s '%%'"

# 4. FZF æ¨¡ç³Šæœç´¢ (æ ¸å¿ƒå¤§æ‹›)
# ä½œç”¨ï¼šå¼¹å‡ºæµ®çª—ï¼Œåˆ—å‡ºæ‰€æœ‰ Sessionï¼Œæ”¯æŒé¢„è§ˆï¼Œå›žè½¦è·³è½¬
# ä¾èµ–ï¼šç³»ç»Ÿéœ€å®‰è£… fzf
bind-key s display-popup -E -w 80% -h 70% "\
    tmux list-sessions -F '#{session_name}' | \
    fzf --reverse --header 'Jump to Session' --preview 'tmux capture-pane -pt {}' | \
    xargs tmux switch-client -t"

# 5. æ€æŽ‰ Session (å¤§å†™ X)
bind-key X display-popup -E "\
    tmux list-sessions -F '#{session_name}' | \
    fzf --reverse --header 'Kill Session' | \
    xargs tmux kill-session -t"

# --- å°å†™ xï¼šé€‰æ‹©ä¼šè¯å¹¶ kill ï¼ˆè¦†ç›–é»˜è®¤ kill-paneï¼‰
unbind x
bind-key x display-popup -E "\
    tmux list-sessions -F '#{session_name}' | \
    fzf --reverse --header 'Kill Session' | \
    xargs tmux kill-session -t"
# ============================================================
# 3. å¤åˆ¶æ¨¡å¼ä¼˜åŒ–
# ============================================================

# åŸºç¡€é€‰æ‹©æ¨¡å¼
bind-key -T copy-mode-vi v send -X begin-selection
bind-key -T copy-mode-vi V send -X select-line

# --- å¿«é€Ÿç¿»é¡µ ---
bind-key -T copy-mode-vi K send-keys -X cursor-up 5
bind-key -T copy-mode-vi J send-keys -X cursor-down 5
bind-key -T copy-mode-vi E send-keys -X cancel
bind-key -T copy-mode-vi H send-keys -X top-line
bind-key -T copy-mode-vi L send-keys -X bottom-line

# ============================================================
# 4. å·®å¼‚åŒ–è®¾ç½® (Mac/Linux åˆ†ç¦»)
# ============================================================

# ðŸŽ macOS (æœ¬åœ° - Purple Theme)
if-shell "uname | grep -q Darwin" {
    # Prefix ä½¿ç”¨ C-qï¼ˆé¿å…ä¸Ž macOS å†²çªï¼‰
    set -g prefix C-q
    bind-key C-q send-prefix

    # Mac æ”¯æŒåŽŸç”Ÿ clipboardï¼ˆpbcopy/pbpasteï¼‰
    set -s set-clipboard on
    set -as terminal-overrides ',*:Ms=\E]52;%p1%s;%p2%s\007'

    # Copy mode â†’ å…¨éƒ¨å¤åˆ¶åˆ° macOS å‰ªè´´æ¿
    bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
    bind-key -T copy-mode-vi Y send-keys -X copy-pipe-and-cancel "pbcopy"

    # ---- Purple Dracula Theme ----
    set -g status-style "bg=#282a36,fg=#f8f8f2"                # bar èƒŒæ™¯æ·±ç´«
    set -g pane-active-border-style "fg=#bd93f9"              # active pane border ç´«è“

    # å·¦ä¾§æ ‡ç­¾
    set -g status-left "#[bg=#bd93f9,fg=#282a36,bold] #S (MAC) #[bg=#282a36,fg=#bd93f9]î‚°"

    # å½“å‰çª—å£é«˜äº®é¢œè‰²
    set -g window-status-current-style "fg=#bd93f9,bold"

    # CPU/MEM å›¾å½¢æ¡ + æ—¶é—´ï¼ˆä»… macOS æ˜¾ç¤ºï¼‰
    set -g status-interval 5
    set -g status-right "#[fg=#6272a4]î‚²#[bg=#6272a4,fg=#f8f8f2] #(bash #{HOME}/scripts/tmux_mac_sysbar.sh) %Y-%m-%d %H:%M "
    if-shell "[ -d ~/.tmux/plugins/tpm ]" 'run-shell "~/.tmux/plugins/tpm/tpm"'
}

# ðŸ§ Linux Server (äº‘ç«¯ - Blue Dracula Theme)
if-shell "uname | grep -q Linux" {
    set -g prefix C-e
    bind-key C-e send-prefix
    set -s set-clipboard on
    set -as terminal-overrides ',*:Ms=\E]52;%p1%s;%p2%s\007'

    # Linux OSC52 å¼ºåŠ›å¤åˆ¶
    bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel \
        'base64 -w0 | sed -e "s/^/\x1b]52;c;/" -e "s/$/\x07/" > /dev/tty'
    bind-key -T copy-mode-vi Y send-keys -X copy-pipe-and-cancel \
        'base64 -w0 | sed -e "s/^/\x1b]52;c;/" -e "s/$/\x07/" > /dev/tty'

    # ---- Blue Dracula Theme ----
    set -g status-style "bg=#44475a,fg=#f8f8f2"
    set -g status-left "#[bg=#8be9fd,fg=#282a36,bold] #S (CLOUD) #[bg=#44475a,fg=#8be9fd]î‚°"
    set -g window-status-current-style "bg=#8be9fd,fg=#282a36,bold"
    set -g pane-active-border-style "fg=#8be9fd"
}
